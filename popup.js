const uiTranslations = {
  en: {
    header: "Gemini Translator",
    info: "Click the \"Translate\" button to translate the page.",
    translateBtn: "Translate",
    excludeBtn: "Don't translate this site",
    optionsBtn: "Open Settings",
    progressText: "Translating... ",
    translationComplete: "Translation completed",
    translationError: "An error occurred",
    noTextFound: "No text found to translate",
    startMessage: "Translation started",
    alreadyExcluded: "This site is already excluded",
    setExcluded: "This site is now excluded from translation",
    batchStats: "Batch: {batches}/{totalBatches}, Texts: {translatedTexts}/{totalTexts}"
  },
  ja: {
    header: "Gemini翻訳",
    info: "ページを翻訳するには「翻訳開始」ボタンをクリックしてください。",
    translateBtn: "翻訳開始",
    excludeBtn: "このサイトでは翻訳を使用しない",
    optionsBtn: "設定を開く",
    progressText: "翻訳中... ",
    translationComplete: "翻訳が完了しました",
    translationError: "エラーが発生しました",
    noTextFound: "翻訳するテキストが見つかりませんでした",
    startMessage: "翻訳を開始しました",
    alreadyExcluded: "このサイトは既に翻訳対象外です",
    setExcluded: "このサイトは翻訳対象外に設定されました",
    batchStats: "バッチ: {batches}/{totalBatches}, テキスト: {translatedTexts}/{totalTexts}"
  },
  fr: {
    header: "Traducteur Gemini",
    info: "Cliquez sur le bouton « Traduire » pour traduire la page.",
    translateBtn: "Traduire",
    excludeBtn: "Ne pas traduire ce site",
    optionsBtn: "Ouvrir les paramètres",
    progressText: "Traduction... ",
    translationComplete: "Traduction terminée",
    translationError: "Une erreur s'est produite",
    noTextFound: "Aucun texte à traduire",
    startMessage: "Traduction lancée",
    alreadyExcluded: "Ce site est déjà exclu",
    setExcluded: "Ce site est maintenant exclu de la traduction",
    batchStats: "Lot : {batches}/{totalBatches}, Textes : {translatedTexts}/{totalTexts}"
  },
  de: {
    header: "Gemini Übersetzer",
    info: "Klicken Sie auf die Schaltfläche „Übersetzen“, um die Seite zu übersetzen.",
    translateBtn: "Übersetzen",
    excludeBtn: "Diese Seite nicht übersetzen",
    optionsBtn: "Einstellungen öffnen",
    progressText: "Übersetzung... ",
    translationComplete: "Übersetzung abgeschlossen",
    translationError: "Ein Fehler ist aufgetreten",
    noTextFound: "Kein zu übersetzender Text gefunden",
    startMessage: "Übersetzung gestartet",
    alreadyExcluded: "Diese Seite ist bereits ausgeschlossen",
    setExcluded: "Diese Seite ist nun von der Übersetzung ausgeschlossen",
    batchStats: "Stapel: {batches}/{totalBatches}, Texte: {translatedTexts}/{totalTexts}"
  },
  es: {
    header: "Traductor Gemini",
    info: "Haga clic en el botón 'Traducir' para traducir la página.",
    translateBtn: "Traducir",
    excludeBtn: "No traducir este sitio",
    optionsBtn: "Abrir configuración",
    progressText: "Traduciendo... ",
    translationComplete: "Traducción completada",
    translationError: "Ocurrió un error",
    noTextFound: "No se encontró texto para traducir",
    startMessage: "Traducción iniciada",
    alreadyExcluded: "Este sitio ya está excluido",
    setExcluded: "Este sitio ahora está excluido de la traducción",
    batchStats: "Lote: {batches}/{totalBatches}, Textos: {translatedTexts}/{totalTexts}"
  },
  it: {
    header: "Traduttore Gemini",
    info: "Clicca sul pulsante 'Traduci' per tradurre la pagina.",
    translateBtn: "Traduci",
    excludeBtn: "Non tradurre questo sito",
    optionsBtn: "Apri Impostazioni",
    progressText: "Traducendo... ",
    translationComplete: "Traduzione completata",
    translationError: "Si è verificato un errore",
    noTextFound: "Nessun testo da tradurre trovato",
    startMessage: "Traduzione avviata",
    alreadyExcluded: "Questo sito è già escluso",
    setExcluded: "Questo sito è ora escluso dalla traduzione",
    batchStats: "Blocco: {batches}/{totalBatches}, Testi: {translatedTexts}/{totalTexts}"
  },
  pt: {
    header: "Tradutor Gemini",
    info: "Clique no botão 'Traduzir' para traduzir a página.",
    translateBtn: "Traduzir",
    excludeBtn: "Não traduzir este site",
    optionsBtn: "Abrir Configurações",
    progressText: "Traduzindo... ",
    translationComplete: "Tradução concluída",
    translationError: "Ocorreu um erro",
    noTextFound: "Nenhum texto encontrado para traduzir",
    startMessage: "Tradução iniciada",
    alreadyExcluded: "Este site já está excluído",
    setExcluded: "Este site agora está excluído da tradução",
    batchStats: "Lote: {batches}/{totalBatches}, Textos: {translatedTexts}/{totalTexts}"
  },
  ru: {
    header: "Переводчик Gemini",
    info: "Нажмите кнопку «Перевести», чтобы перевести страницу.",
    translateBtn: "Перевести",
    excludeBtn: "Не переводить этот сайт",
    optionsBtn: "Открыть настройки",
    progressText: "Перевод... ",
    translationComplete: "Перевод завершен",
    translationError: "Произошла ошибка",
    noTextFound: "Текст для перевода не найден",
    startMessage: "Перевод запущен",
    alreadyExcluded: "Этот сайт уже исключен",
    setExcluded: "Этот сайт теперь исключен из перевода",
    batchStats: "Пакет: {batches}/{totalBatches}, Тексты: {translatedTexts}/{totalTexts}"
  },
  zh: {
    header: "Gemini翻译",
    info: "点击“翻译”按钮以翻译页面。",
    translateBtn: "翻译",
    excludeBtn: "不翻译此网站",
    optionsBtn: "打开设置",
    progressText: "翻译中... ",
    translationComplete: "翻译完成",
    translationError: "发生错误",
    noTextFound: "没有可翻译的文本",
    startMessage: "翻译已开始",
    alreadyExcluded: "该网站已被排除",
    setExcluded: "该网站现已被排除在翻译之外",
    batchStats: "批次: {batches}/{totalBatches}, 文本: {translatedTexts}/{totalTexts}"
  },
  ko: {
    header: "Gemini 번역기",
    info: "페이지를 번역하려면 '번역' 버튼을 클릭하세요.",
    translateBtn: "번역",
    excludeBtn: "이 사이트는 번역하지 않음",
    optionsBtn: "설정 열기",
    progressText: "번역 중... ",
    translationComplete: "번역이 완료되었습니다",
    translationError: "오류가 발생했습니다",
    noTextFound: "번역할 텍스트가 없습니다",
    startMessage: "번역을 시작했습니다",
    alreadyExcluded: "이 사이트는 이미 제외되었습니다",
    setExcluded: "이 사이트는 이제 번역에서 제외됩니다",
    batchStats: "배치: {batches}/{totalBatches}, 텍스트: {translatedTexts}/{totalTexts}"
  },
  hi: {
    header: "जेमिनी अनुवादक",
    info: "पृष्ठ का अनुवाद करने के लिए \"अनुवाद\" बटन पर क्लिक करें।",
    translateBtn: "अनुवाद",
    excludeBtn: "इस साइट का अनुवाद न करें",
    optionsBtn: "सेटिंग्स खोलें",
    progressText: "अनुवाद चल रहा है... ",
    translationComplete: "अनुवाद पूरा हुआ",
    translationError: "एक त्रुटि हुई",
    noTextFound: "अनुवाद करने के लिए कोई पाठ नहीं मिला",
    startMessage: "अनुवाद शुरू हुआ",
    alreadyExcluded: "यह साइट पहले से ही बाहर रखी गई है",
    setExcluded: "यह साइट अब अनुवाद से बाहर रखी गई है",
    batchStats: "बैच: {batches}/{totalBatches}, पाठ: {translatedTexts}/{totalTexts}"
  },
  ar: {
    header: "مترجم جيميني",
    info: "انقر على زر \"ترجمة\" لترجمة الصفحة.",
    translateBtn: "ترجمة",
    excludeBtn: "لا تترجم هذا الموقع",
    optionsBtn: "افتح الإعدادات",
    progressText: "جارٍ الترجمة... ",
    translationComplete: "اكتملت الترجمة",
    translationError: "حدث خطأ",
    noTextFound: "لم يتم العثور على نص للترجمة",
    startMessage: "بدأت الترجمة",
    alreadyExcluded: "هذا الموقع مستبعد بالفعل",
    setExcluded: "هذا الموقع مستبعد الآن من الترجمة",
    batchStats: "الدفعة: {batches}/{totalBatches}, النصوص: {translatedTexts}/{totalTexts}"
  },
  bn: {
    header: "জেমিনি অনুবাদক",
    info: "পৃষ্ঠাটি অনুবাদ করতে \"অনুবাদ\" বোতামে ক্লিক করুন।",
    translateBtn: "অনুবাদ",
    excludeBtn: "এই সাইটটি অনুবাদ করবেন না",
    optionsBtn: "সেটিংস খুলুন",
    progressText: "অনুবাদ চলছে... ",
    translationComplete: "অনুবাদ সম্পন্ন হয়েছে",
    translationError: "একটি ত্রুটি ঘটেছে",
    noTextFound: "অনুবাদ করার জন্য কোনও টেক্সট পাওয়া যায়নি",
    startMessage: "অনুবাদ শুরু হয়েছে",
    alreadyExcluded: "এই সাইটটি ইতিমধ্যেই বাদ দেওয়া হয়েছে",
    setExcluded: "এই সাইটটি এখন অনুবাদ থেকে বাদ দেওয়া হয়েছে",
    batchStats: "ব্যাচ: {batches}/{totalBatches}, টেক্সট: {translatedTexts}/{totalTexts}"
  },
  id: {
    header: "Penerjemah Gemini",
    info: "Klik tombol \"Terjemahkan\" untuk menerjemahkan halaman.",
    translateBtn: "Terjemahkan",
    excludeBtn: "Jangan terjemahkan situs ini",
    optionsBtn: "Buka Pengaturan",
    progressText: "Menerjemahkan... ",
    translationComplete: "Terjemahan selesai",
    translationError: "Terjadi kesalahan",
    noTextFound: "Tidak ada teks yang ditemukan untuk diterjemahkan",
    startMessage: "Terjemahan dimulai",
    alreadyExcluded: "Situs ini sudah dikecualikan",
    setExcluded: "Situs ini sekarang dikecualikan dari terjemahan",
    batchStats: "Batch: {batches}/{totalBatches}, Teks: {translatedTexts}/{totalTexts}"
  },
  tr: {
    header: "Gemini Çevirmen",
    info: "Sayfayı çevirmek için \"Çevir\" düğmesine tıklayın.",
    translateBtn: "Çevir",
    excludeBtn: "Bu siteyi çevirme",
    optionsBtn: "Ayarları Aç",
    progressText: "Çevriliyor... ",
    translationComplete: "Çeviri tamamlandı",
    translationError: "Bir hata oluştu",
    noTextFound: "Çevrilecek metin bulunamadı",
    startMessage: "Çeviri başladı",
    alreadyExcluded: "Bu site zaten hariç tutulmuş",
    setExcluded: "Bu site artık çeviriden hariç tutuldu",
    batchStats: "Toplu: {batches}/{totalBatches}, Metinler: {translatedTexts}/{totalTexts}"
  }
};

let currentLangTexts = uiTranslations.en;

function initPopupUI() {
  chrome.storage.local.get(['targetLanguage'], function(items) {
    const lang = items.targetLanguage || 'en';
    currentLangTexts = uiTranslations[lang] || uiTranslations.en;
    document.querySelector('.header').textContent = currentLangTexts.header;
    document.querySelector('.info').textContent = currentLangTexts.info;
    document.getElementById('translateBtn').textContent = currentLangTexts.translateBtn;
    document.getElementById('excludeBtn').textContent = currentLangTexts.excludeBtn;
    document.getElementById('optionsBtn').textContent = currentLangTexts.optionsBtn;
  });
}

function checkTranslationStatus() {
  chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
    if (!tabs[0]) return;
    chrome.tabs.sendMessage(tabs[0].id, {action: "getTranslationStatus"}, function(response) {
      if (chrome.runtime.lastError) {
        hideProgress();
        return;
      }
      if (response && response.isTranslating) {
        showProgress(response.progress);
        if (response.stats) {
          updateStats(response.stats);
        }
      } else {
        hideProgress();
      }
    });
  });
}

function showProgress(percent) {
  document.getElementById('progressContainer').style.display = 'block';
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressText').textContent = currentLangTexts.progressText + percent + '%';
  document.getElementById('translateBtn').disabled = true;
}

function updateStats(stats) {
  const statsElement = document.getElementById('statsText');
  const pattern = currentLangTexts.batchStats;
  const replaced = pattern
    .replace('{batches}', stats.batches)
    .replace('{totalBatches}', stats.totalBatches)
    .replace('{translatedTexts}', stats.translatedTexts)
    .replace('{totalTexts}', stats.totalTexts);
  statsElement.textContent = replaced;
}

function hideProgress() {
  document.getElementById('progressContainer').style.display = 'none';
  document.getElementById('translateBtn').disabled = false;
}

function translatePage() {
  chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
    if (!tabs[0]) return;
    chrome.tabs.sendMessage(tabs[0].id, {action: "startTranslation"}, function(response) {
      if (chrome.runtime.lastError) {
        document.getElementById('statusText').textContent = currentLangTexts.translationError + ": " + chrome.runtime.lastError.message;
        return;
      }
      if (response && response.status === "started") {
        showProgress(0);
        document.getElementById('statusText').textContent = currentLangTexts.startMessage;
      } else if (response && response.error) {
        document.getElementById('statusText').textContent = currentLangTexts.translationError + ": " + response.error;
      }
    });
  });
}

function excludeCurrentSite() {
  chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
    if (!tabs[0] || !tabs[0].url) return;
    const currentUrl = tabs[0].url;
    chrome.storage.local.get(['excludeList'], function(items) {
      let excludeList = [];
      if (items.excludeList && Array.isArray(items.excludeList)) {
        excludeList = items.excludeList;
      }
      if (!excludeList.includes(currentUrl)) {
        excludeList.push(currentUrl);
        chrome.storage.local.set({ excludeList: excludeList }, function() {
          document.getElementById('statusText').textContent = currentLangTexts.setExcluded;
        });
      } else {
        document.getElementById('statusText').textContent = currentLangTexts.alreadyExcluded;
      }
    });
  });
}

document.addEventListener('DOMContentLoaded', function() {
  initPopupUI();
  checkTranslationStatus();

  document.getElementById('translateBtn').addEventListener('click', translatePage);
  document.getElementById('excludeBtn').addEventListener('click', excludeCurrentSite);
  document.getElementById('optionsBtn').addEventListener('click', function() {
    chrome.runtime.openOptionsPage();
  });

  setInterval(checkTranslationStatus, 1000);
});

chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
  if (request.action === "updateProgress") {
    showProgress(request.progress);
    if (request.stats) {
      updateStats(request.stats);
    }
  } else if (request.action === "translationComplete") {
    hideProgress();
    if (request.message) {
      document.getElementById('statusText').textContent = request.message;
    } else {
      document.getElementById('statusText').textContent = currentLangTexts.translationComplete;
    }
  } else if (request.action === "translationError") {
    hideProgress();
    if (request.error) {
      document.getElementById('statusText').textContent = request.error;
    } else {
      document.getElementById('statusText').textContent = currentLangTexts.translationError;
    }
  }
  return true;
});